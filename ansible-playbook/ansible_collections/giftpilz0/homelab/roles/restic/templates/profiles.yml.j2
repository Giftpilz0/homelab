# resticprofile configuration for {{ inventory_hostname }}
# Generated by Ansible - do not edit manually
# yaml-language-server: $schema=https://creativeprojects.github.io/resticprofile/jsonschema/config-2.json

version: "2"

global:
  default-command: snapshots
  priority: low

profiles:
{% for repo in restic_repositories %}
  {{ repo.name }}:
    repository: "rest:http://{{ restic_server_host }}:8000/{{ inventory_hostname }}/{{ repo.name }}"
    password-file: "{{ restic_password_dir }}/{{ repo.name }}.txt"
    initialize: true
    env:
      RESTIC_CACHE_DIR: "{{ restic_cache_dir }}/{{ repo.name }}"

    backup:
      source:
{% for path in repo.backup_paths %}
        - "{{ path }}"
{% endfor %}
{% if repo.exclude_patterns | default([]) | length > 0 %}
      exclude:
{% for pattern in repo.exclude_patterns %}
        - "{{ pattern }}"
{% endfor %}
{% endif %}
      exclude-caches: true
      one-file-system: true
      schedule:
        permission: system
        at: "{{ repo.schedule }}"
        log: "{{ restic_log_dir }}/{{ repo.name }}-backup.log"
      tag:
        - "{{ inventory_hostname }}"
        - "{{ repo.name }}"
      run-before:
        - "echo 'Starting backup for {{ repo.name }} at $(date)'"
      run-after:
        - "echo 'Backup completed for {{ repo.name }} at $(date)'"
        - "chown -R {{ restic_user }}:{{ restic_user }} {{ restic_cache_dir }}/{{ repo.name }}"
      run-after-fail:
        - "echo 'Backup FAILED for {{ repo.name }} at $(date)'"

    retention:
      after-backup: true
      keep-daily: {{ repo.retention.keep_daily | default(14) }}
      keep-weekly: {{ repo.retention.keep_weekly | default(8) }}
      keep-monthly: {{ repo.retention.keep_monthly | default(12) }}
      keep-yearly: {{ repo.retention.keep_yearly | default(3) }}
      prune: true
      host: true
      tag: true

    check:
      read-data-subset: "10%"
      schedule:
        permission: system
        at: "Sun 03:00"
        log: "{{ restic_log_dir }}/{{ repo.name }}-check.log"

{% endfor %}
